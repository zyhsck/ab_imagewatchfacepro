(()=>{"use strict";var e={},t={};function o(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,o),r.exports}function i(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.config)?void 0:t.readConfig))return JSON.parse(globalThis.AstroBox.config.readConfig());throw Error("AstroBox.config.readConfig not available on native side")}function n(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.config)?void 0:o.writeConfig))globalThis.AstroBox.config.writeConfig(JSON.stringify(e));else throw Error("AstroBox.config.writeConfig not available on native side")}function r(e){let t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],o="",i,n=e.length;for(i=2;i<n;i+=3)o+=t[e[i-2]>>2],o+=t[(3&e[i-2])<<4|e[i-1]>>4],o+=t[(15&e[i-1])<<2|e[i]>>6],o+=t[63&e[i]];return i===n+1&&(o+=t[e[i-2]>>2],o+=t[(3&e[i-2])<<4],o+="=="),i===n&&(o+=t[e[i-2]>>2],o+=t[(3&e[i-2])<<4|e[i-1]>>4],o+=t[(15&e[i-1])<<2],o+="="),o}function l(e){if((e=e.replace(/[\r\n\s]/g,"")).length%4!=0)throw Error("Invalid base64 string length");let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0;e.endsWith("==")?o=2:e.endsWith("=")&&(o=1);let i=e.length/4*3-o,n=new Uint8Array(i),r=0;for(let o=0;o<e.length;o+=4){let l=t.indexOf(e[o])<<18|t.indexOf(e[o+1])<<12|t.indexOf(e[o+2])<<6|t.indexOf(e[o+3]);r<i&&(n[r++]=l>>16&255),r<i&&(n[r++]=l>>8&255),r<i&&(n[r++]=255&l)}return n}async function a(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.debug)?void 0:o.sendRaw))await globalThis.AstroBox.debug.sendRaw(r(e));else throw Error("AstroBox.debug.sendRaw not available on native side")}function s(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.getDeviceList))return JSON.parse(globalThis.AstroBox.device.getDeviceList());throw Error("AstroBox.device.getDeviceList not available on native side")}function c(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:o.getDeviceState))return JSON.parse(globalThis.AstroBox.device.getDeviceState(e));throw Error("AstroBox.device.getDeviceState not available on native side")}function d(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.device)?void 0:i.modifyDeviceState))globalThis.AstroBox.device.modifyDeviceState(e,JSON.stringify(t));else throw Error("AstroBox.device.modifyDeviceState not available on native side")}async function u(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.disconnectDevice))await globalThis.AstroBox.device.disconnectDevice();else throw Error("AstroBox.device.disconnectDevice not available on native side")}function f(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.event)?void 0:i.addEventListener))globalThis.AstroBox.event.addEventListener(e,t);else throw Error("AstroBox.event.addEventListener not available")}function v(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.event)?void 0:o.removeEventListener))globalThis.AstroBox.event.removeEventListener(e);else throw Error("AstroBox.event.removeEventListener not available")}function g(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.event)?void 0:i.sendEvent))globalThis.AstroBox.event.sendEvent(e,t);else throw Error("AstroBox.event.sendEvent not available")}function y(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},i=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),i.forEach(function(t){var i;i=o[t],t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i})}return e}async function p(e){var t,o;let i=y({decode_text:!1,encoding:"undefined"},e);if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:o.pickFile))return JSON.parse(await globalThis.AstroBox.filesystem.pickFile(JSON.stringify(i)));throw Error("AstroBox.filesystem.pickFile not available")}async function h(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.filesystem)?void 0:i.readFile)){let o=y({offset:0,decode_text:!0},t);var n=await globalThis.AstroBox.filesystem.readFile(e,JSON.stringify(o));return o.decode_text?n:l(n)}throw Error("AstroBox.filesystem.readFile not available")}async function b(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:o.unloadFile))return await globalThis.AstroBox.filesystem.unloadFile(e);throw Error("AstroBox.filesystem.unloadFile not available")}function x(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.installer)?void 0:i[e]))globalThis.AstroBox.installer[e](t);else throw Error("AstroBox.installer.".concat(e," not available"))}o.rv=()=>"1.4.10",o.ruid="bundler=rspack@1.4.10";let A=e=>x("addThirdPartyAppToQueue",e),B=e=>x("addWatchFaceToQueue",e),w=e=>x("addFirmwareToQueue",e);async function T(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.interconnect)?void 0:i.sendQAICMessage))await globalThis.AstroBox.interconnect.sendQAICMessage(e,t);else throw Error("AstroBox.interconnect.sendQAICMessage not available")}function m(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.lifecycle)?void 0:o.onLoad))globalThis.AstroBox.lifecycle.onLoad(e);else throw Error("AstroBox.lifecycle.onLoad not available")}function E(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.native)?void 0:o.regNativeFun))return globalThis.AstroBox.native.regNativeFun(e);throw Error("AstroBox.native.regNativeFun not available")}async function O(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.network)?void 0:i.fetch)){t.body_encoded="string"!=typeof t.body,t.body=t.body?t.body_encoded?r(t.body):t.body:"";let o=await globalThis.AstroBox.network.fetch(e,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},i=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),i.forEach(function(t){var i;i=o[t],t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i})}return e}({raw:!1},t)));return o.body=t.raw?l(o.body):o.body,o}throw Error("AstroBox.network.fetch not available")}async function D(e){var t,o;if("function"==typeof(null==(o=null==(t=globalThis.AstroBox)?void 0:t.provider)?void 0:o.registerCommunityProvider))await globalThis.AstroBox.provider.registerCommunityProvider(JSON.stringify(e));else throw Error("AstroBox.provider.registerCommunityProvider not available")}async function S(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.thirdpartyapp)?void 0:i.launchQA))await globalThis.AstroBox.thirdpartyapp.launchQA(JSON.stringify(e),t);else throw Error("AstroBox.thirdpartyapp.launchQA not available")}async function P(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.thirdpartyapp)?void 0:t.getThirdPartyAppList))return JSON.parse(await globalThis.AstroBox.thirdpartyapp.getThirdPartyAppList());throw Error("AstroBox.thirdpartyapp.getThirdPartyAppList not available")}function _(e,t){var o,i;if("function"==typeof(null==(i=null==(o=globalThis.AstroBox)?void 0:o.ui)?void 0:i[e]))globalThis.AstroBox.ui[e](t);else throw Error("AstroBox.ui.".concat(e," not available"))}let F=e=>_("updatePluginSettingsUI",JSON.stringify(e)),N=e=>_("openPageWithNodes",JSON.stringify(e)),U=e=>_("openPageWithUrl",e),k={};!function(e){e.config={},e.config.readConfig=i,e.config.writeConfig=n,e.debug={},e.debug.sendRaw=a,e.device={},e.device.getDeviceList=s,e.device.getDeviceState=c,e.device.modifyDeviceState=d,e.device.disconnectDevice=u,e.event={},e.event.addEventListener=f,e.event.removeEventListener=v,e.event.sendEvent=g,e.installer={},e.installer.addThirdPartyAppToQueue=A,e.installer.addWatchFaceToQueue=B,e.installer.addFirmwareToQueue=w,e.interconnect={},e.interconnect.sendQAICMessage=T,e.lifecycle={},e.lifecycle.onLoad=m,e.native={},e.native.regNativeFun=E,e.network={},e.network.fetch=O,e.provider={},e.provider.registerCommunityProvider=D,e.thirdpartyapp={},e.thirdpartyapp.launchQA=S,e.thirdpartyapp.getThirdPartyAppList=P,e.ui={},e.ui.updatePluginSettingsUI=F,e.ui.openPageWithNodes=N,e.ui.openPageWithUrl=U,e.filesystem={},e.filesystem.pickFile=p,e.filesystem.readFile=h,e.filesystem.unloadFile=b}(k);let L="https://astroboxplugins.1417402449.workers.dev/",J="zyhsck/ab-",C={model:"",file:""},G=null,j="等待生成...",I=[],Q=!1,R="";async function W(){try{console.log("[DEBUG] 开始选择文件..."),j="正在选择文件...",M(),G&&(console.log("[DEBUG] 卸载旧文件:",G.path),await k.filesystem.unloadFile(G.path)),console.log("[DEBUG] 调用 pickFile API"),G=await k.filesystem.pickFile({decode_text:!1}),console.log("[DEBUG] 文件选择结果:",{path:G.path,size:G.size}),console.log("[DEBUG] 读取文件内容:",G.path);let e=await k.filesystem.readFile(G.path,{len:G.size,decode_text:!1});console.log("[DEBUG] 编码文件为 base64"),C.file=function(e){let t=new Uint8Array(e),o=[];for(let e=0;e<t.length;e+=3){let i=t.slice(e,e+3);o.push(i)}let i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="";return o.forEach(e=>{let[t,o=0,r=0]=e,l=t>>2,a=(3&t)<<4|o>>4,s=(15&o)<<2|r>>6;3===e.length?n+=i[l]+i[a]+i[s]+i[63&r]:2===e.length?n+=i[l]+i[a]+i[s]+"=":n+=i[l]+i[a]+"=="}),n}(e),console.log("[DEBUG] 文件选择成功"),j="文件选择成功!",M()}catch(e){console.error("选择文件失败:",e),j="文件选择错误: "+e.message,M()}}async function z(){try{if(console.log("[DEBUG] 开始处理提交"),!C.file||!C.model){console.log("[DEBUG] 缺少文件或模板"),j="请先选择图片和模板",M();return}console.log("[DEBUG] 验证用户权限"),j="正在验证用户权限...",M();let e="https://picfacepro-users.1417402449.workers.dev/";console.log("[DEBUG] 请求验证URL:",e);let t=await k.network.fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:Z()})});console.log("[DEBUG] 验证响应:",{status:t.status,body:t.body});let o=JSON.parse(t.body);if(!o.allowed){console.log("[DEBUG] 权限验证失败 - 完整响应:",JSON.stringify(o,null,2)),j="权限验证失败: "+(o.status||"未购买或试用次数已用完"),M();return}console.log("[DEBUG] 权限验证通过"),j="正在处理...",M(),console.log("[DEBUG] 触发Cloudflare工作流");let i=await X();R="https://github.com/".concat(J,"/releases/tag/face-").concat(i),j="生成成功! 下载链接: ".concat(R),Q=!0,console.log("[DEBUG] 生成成功，下载链接:",R),M()}catch(e){j="错误: "+e.message,M()}}function M(){let e=[{node_id:"tips_text1",visibility:!0,disabled:!1,content:{type:"Text",value:"建议看完简介里的网站里的用户指南后再使用本插件"}},{node_id:"result_text1",visibility:!0,disabled:!1,content:{type:"Text",value:"选择适配手表分辨率的图片(需要png或jpeg格式)"}},{node_id:"file_btn",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:G?"重新选择文件":"选择文件",callback_fun_id:q}}},{node_id:"result_text2",visibility:!0,disabled:!1,content:{type:"Text",value:"选择适配手表的模板"}},{node_id:"fprj_select",visibility:!0,disabled:!1,content:{type:"Dropdown",value:{options:I.length>0?I:["正在加载模板列表..."],callback_fun_id:H}}},{node_id:"result_text",visibility:!0,disabled:!1,content:{type:"Text",value:j}},{node_id:"result_text2",visibility:!0,disabled:!1,content:{type:"Text",value:"未发电用户每个月只有2次免费机会"}},{node_id:"submit_btn",visibility:!0,disabled:!C.file||!C.model,content:{type:"Button",value:{primary:!0,text:"开始生成",callback_fun_id:K}}},{node_id:"open_link_btn",visibility:!0,disabled:!Q,content:{type:"Button",value:{primary:!0,text:"打开下载链接",callback_fun_id:V}}}];k.ui.updatePluginSettingsUI(e)}let q=k.native.regNativeFun(W),H=k.native.regNativeFun(function(e){console.log("[DEBUG] 选择模板:",e),C.model=e,j="已选择模板: ".concat(e),M()}),K=k.native.regNativeFun(z),V=k.native.regNativeFun(()=>{k.ui.openPageWithUrl(R)});async function X(){let e="".concat(L,"?action=generate&repo=").concat(encodeURIComponent(J)),t=await k.network.fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:C.model,file:C.file,mac:Z()})});if(200===t.status){let e=JSON.parse(t.body);if("success"===e.status)return e.run_id;throw Error(e.message||"触发工作流失败")}throw Error("请求失败: ".concat(t.status))}async function Y(){try{console.log("正在从API获取FPRJ列表...");let e="".concat(L,"?action=list&repo=").concat(encodeURIComponent(J),"&ext=fprj"),t=await k.network.fetch(e,{method:"GET",headers:{Accept:"application/json","User-Agent":"AstroBox-Plugin"}});if(200===t.status){let e=JSON.parse(t.body);if("success"===e.status&&Array.isArray(e.files))return I=e.files.map(e=>e.path),j="已找到 ".concat(e.file_count," 个模板"),M(),!0;throw Error("API返回数据格式错误")}throw Error("API请求失败: ".concat(t.status))}catch(e){throw console.error("获取FPRJ列表失败:",e),e}}function Z(){let e=k.device.getDeviceList();return 0===e.length?"":e[0].addr}j="正在加载模板列表...",M(),k.lifecycle.onLoad(async()=>{j="正在加载模板列表...",M();try{await Y()}catch(e){j="加载失败: "+e.message,M()}})})();
//# sourceMappingURL=main.js.map